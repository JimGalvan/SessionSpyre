<script>
    document.addEventListener('DOMContentLoaded', function () {
        
        const updateLiveStatus = function (liveStatusSocket) {
            // Handle live status updates
            liveStatusSocket.onmessage = function (event) {
                const data = JSON.parse(event.data);
                const sessionRow = document.querySelector(`#${data.session_id}`);

                if (sessionRow) {
                    console.log("Session row: " + sessionRow);
                    const statusCell = sessionRow.querySelector('.live-status');
                    if (data.live) {
                        console.log('Live');
                        statusCell.innerHTML = '<span class="text-green-500">Live</span>';
                    } else {
                        console.log('Not Live');
                        statusCell.innerHTML = '<span class="text-gray-500">Not Live</span>';
                    }
                }
            };
        };

        // WebSocket for live status updates
        const liveStatusSocket = new WebSocket('ws://localhost:8000/ws/live-status/');
        const sessionUpdatesSocket = new WebSocket('ws://localhost:8000/ws/session-updates/');

        // Handle new session creation
        sessionUpdatesSocket.onmessage = function (event) {
            const data = JSON.parse(event.data);

            if (data.action === 'session-created') {
                htmx.trigger('#sessions-container', 'session-created');
                document.addEventListener('htmx:afterSettle', function (event) {
                    if (event.detail.target.id === 'sessions-container') {
                        updateLiveStatus(liveStatusSocket);
                    }
                });
            }
        };
        updateLiveStatus(liveStatusSocket);

        liveStatusSocket.onclose = function () {
            console.log("WebSocket connection for live status closed.");
        };

        sessionUpdatesSocket.onclose = function () {
            console.log("WebSocket connection for session updates closed.");
        };
    });
</script>
<div id="sessions-container"
     hx-get="{% url 'sessions_list' %}"
     hx-trigger="every 10s session-created"
     hx-target="#sessions-container"
     hx-swap="innerHTML">
<table id="sessions" class="min-w-full bg-white border border-gray-200">
    <thead>
    <tr class="w-full bg-gray-800 text-white">
        <th class="py-2 px-4 border-b">Session ID</th>
        <th class="py-2 px-4 border-b">Date</th>
        <th class="py-2 px-4 border-b">Live Status</th> <!-- New Column -->
        <th class="py-2 px-4 border-b">Actions</th>
    </tr>
    </thead>
    <tbody>
    {% if sessions %}
        {% for session in sessions %}
            <tr id="{{ session.session_id }}" class="hover:bg-gray-100">
                <td class="py-2 px-4 border-b">{{ session.session_id }}</td>
                <td class="py-2 px-4 border-b">{{ session.created_at }}</td>
                <td class="py-2 px-4 border-b">
                    {% if session.live %}
                        <span class="live-status text-green-500">Live</span>
                    {% else %}
                        <span class="live-status text-gray-500">Not Live</span>
                    {% endif %}
                </td>
                <td class="py-2 px-4 border-b">
                    <div>
                        <button type="button"
                                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                hx-delete="{% url 'delete_session' session.session_id %}"
                                hx-target="#sessions"
                                hx-trigger="click"
                                class="text-red-500 hover:underline">Delete
                        </button>
                        <a href="{% url 'replay_session' session.session_id %}"
                           class="text-blue-500 hover:underline">Replay</a>
                    </div>
                </td>
            </tr>
        {% endfor %}
    {% else %}
        <tr>
            <td class="py-2 px-4 border-b" colspan="4">No sessions found.</td>
        </tr>
    {% endif %}
    </tbody>
</table>
</div>
